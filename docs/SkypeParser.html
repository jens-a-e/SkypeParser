<!DOCTYPE html>  <html> <head>   <title>SkypeParser.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               SkypeParser.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <h1>#</h1>

<p>Parse Messages from a Skype conversation in to a JSON Object.
jens a. ewald, ififelse.net, 2012, licensed by the unlicence</p>

<h1>#</h1>             </td>             <td class="code">               <div class="highlight"><pre><span class="nb">String</span><span class="o">::</span><span class="nv">parsefromSkype = </span><span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>The parser must be different for Windows or Mac Version.
Linux is not tested yet.</p>

<p>On Windows the input looks something like this:</p>

<blockquote>
  <p>[17:25:06] Jane Doe: Howdy! ... <br />
  [17:26:10] John Doe: Oh! Hi Jane, nic... <br />
  [17:28:28] John Doe: How's the weath...  </p>
</blockquote>

<p>The Mac Version gives you more this style:</p>

<blockquote>
  <p>Jane Doe 28.10.11 12:31 <br />
  Howdy! Nice to see you! <br />
  John Doe 28.10.11 12:31 <br />
  Oh! Hi Jane, nice weather today, isn't it <br />
  28.10.11 12:31 <br />
  How's the weather in Australia?  </p>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p><em>Store the platform flag for later use!</em>
So, we can dissect it with two different RegExp.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">platform_is_windows = </span><span class="nx">@</span><span class="p">.</span><span class="nx">match</span> <span class="sr">/^\[\d{2}/</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <h4>The RegExp for Windows style messages</h4>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">parser = </span><span class="k">if</span> <span class="nx">platform_is_windows</span>
    <span class="sr">///</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>First find the time!</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="sr">(</span>
<span class="sr">        \[</span>
<span class="sr">          (\d{2}:\d{2}:\d{2})</span>
<span class="sr">        \]</span>
<span class="sr">      )</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Time and the actual message are always seperated with a space!</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="sr">\s</span>
<span class="sr">      (</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>The message can be just a message ...</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="sr">(</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>so, we  have users name</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="sr">(.+)</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>which is seperated with a colon and a space</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="sr">:\s</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>from the message text (which runs across multiple lines)</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="sr">([\s\S]+?)</span>
<span class="sr">        )</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>... or we have a state change / sysex message</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="sr">|</span>
<span class="sr">        (</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>which starts with 3 asterix'</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="sr">(\*{3})\s</span>
<span class="sr">          (</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>and can be a new user by an existing user</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="sr">((.+)\shat\s(.+?)\shinzu.+)</span>
<span class="sr">            |</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>or the topic has been changed by an existing user.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="sr">((.+)\shat\sdas\s(Thema).+\sin\s&quot;(.+)&quot;)</span>
<span class="sr">          )</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Afterwards the sysex closes with 3 asterix' again.</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="sr">\s\*{3}</span>
<span class="sr">        )</span>
<span class="sr">      )</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>As each message block is either followed by a line break and a new time
tag or the end of the string, we look ahead for it:</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="sr">(?=(\r\n\[\d{2}:\d{2}:\d{2}\])|$)</span>
<span class="sr">    ///g</span>
  <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <h4>The RegExp for Mac style messages</h4>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="sr">///</span>
      <span class="sr">(</span>
<span class="sr">        (</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Meta information</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="sr">(</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Username</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="sr">(.*)\s</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Date</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="sr">(</span>
<span class="sr">              (\d+)\.(\d+)\.(\d+)\s+(\d+):(\d+)</span>
<span class="sr">            )</span>
<span class="sr">            (?=\s|\n)</span>
<span class="sr">          )</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>The message itself</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="sr">(</span>
<span class="sr">            (.|(\n(?!.*\d{2}\.)))+</span>
<span class="sr">          )</span>
<span class="sr">        )</span>
<span class="sr">      )</span>
<span class="sr">    ///g</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>Whitelist of Values</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">include = </span><span class="k">if</span> <span class="nx">platform_is_windows</span>
    <span class="p">[</span>
      <span class="mi">2</span>  <span class="c1"># Date/Time</span>
      <span class="mi">5</span>  <span class="c1"># Username</span>
      <span class="mi">6</span>  <span class="c1"># Message</span>
      <span class="mi">8</span>  <span class="c1"># Sysex Token</span>
      <span class="mi">14</span> <span class="c1"># Sysex User (Topic)</span>
      <span class="mi">15</span> <span class="c1"># Sysex Topic Command</span>
      <span class="mi">16</span> <span class="c1"># Sysex New Topic name</span>
      <span class="mi">11</span> <span class="c1"># Sysex User (UserAdd)</span>
      <span class="mi">12</span> <span class="c1"># Sysex UserAdd New Users name</span>
    <span class="p">]</span>
  <span class="k">else</span>
    <span class="p">[</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Mac Whitelist to come</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="p">]</span>

  <span class="nv">_topics = </span><span class="p">[]</span>
  <span class="nv">topics = </span><span class="p">[]</span>
  <span class="nv">_users  = </span><span class="p">[]</span>
  <span class="nv">users  = </span><span class="p">[]</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>With the parser RegExp and the platform flag we can parse the message string,
build a collection object and return it.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">messages = </span><span class="k">while</span> <span class="nv">_result = </span><span class="nx">parser</span><span class="p">.</span><span class="nx">exec</span> <span class="nx">@</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>Start with some fresh vars:</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="p">[</span><span class="nx">time</span><span class="p">,</span><span class="nx">user</span><span class="p">,</span><span class="nx">message</span><span class="p">,</span><span class="nx">token</span><span class="p">,</span><span class="nx">command</span><span class="p">,</span><span class="nx">newuser</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="mi">7</span><span class="p">))</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>Retrieve the whitelisted parts from the hit</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">res = </span><span class="p">(</span><span class="nx">match</span> <span class="k">for</span> <span class="nx">match</span><span class="p">,</span><span class="nx">index</span> <span class="k">in</span> <span class="nx">_result</span> <span class="k">when</span> <span class="nx">index</span> <span class="k">in</span> <span class="nx">include</span> <span class="o">and</span> <span class="nx">match</span> <span class="o">isnt</span> <span class="kc">undefined</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">res</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">3</span> <span class="c1"># we have a normal message</span>
      <span class="p">[</span><span class="nx">time</span><span class="p">,</span><span class="nx">user</span><span class="p">,</span><span class="nx">message</span><span class="p">]</span> <span class="o">=</span> <span class="nx">res</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">res</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">4</span> <span class="c1"># we have a sysex message for new user</span>
      <span class="p">[</span><span class="nx">time</span><span class="p">,</span><span class="nx">token</span><span class="p">,</span><span class="nx">user</span><span class="p">,</span><span class="nx">newuser</span><span class="p">]</span> <span class="o">=</span> <span class="nx">res</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">res</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">5</span> <span class="c1"># we have a sysex message for new topic</span>
      <span class="p">[</span><span class="nx">time</span><span class="p">,</span><span class="nx">token</span><span class="p">,</span><span class="nx">user</span><span class="p">,</span><span class="nx">command</span><span class="p">,</span><span class="nx">topic</span><span class="p">]</span> <span class="o">=</span> <span class="nx">res</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>Parse the time</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">time = </span><span class="nb">Date</span><span class="p">.</span><span class="nx">fromClockTime</span><span class="p">(</span><span class="nx">time</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Update the users buffer</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">user</span> <span class="o">and</span> <span class="nx">user</span> <span class="o">not</span> <span class="k">in</span> <span class="nx">_users</span>
      <span class="nx">users</span><span class="p">.</span><span class="nx">push</span>  <span class="p">{</span><span class="nx">name</span><span class="o">:</span><span class="nx">user</span><span class="p">,</span><span class="nx">joined_on</span><span class="o">:</span><span class="nx">time</span><span class="p">}</span>
      <span class="nx">_users</span><span class="p">.</span><span class="nx">push</span> <span class="nx">user</span>
    <span class="k">if</span> <span class="nx">newuser</span> <span class="o">and</span> <span class="nx">newuser</span> <span class="o">not</span> <span class="k">in</span> <span class="nx">_users</span>
      <span class="nx">users</span><span class="p">.</span><span class="nx">push</span>  <span class="p">{</span><span class="nx">name</span><span class="o">:</span><span class="nx">newuser</span><span class="p">,</span><span class="nx">joined_on</span><span class="o">:</span><span class="nx">time</span><span class="p">}</span>
      <span class="nx">_users</span><span class="p">.</span><span class="nx">push</span> <span class="nx">newuser</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>Update the topics buffer</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">topic</span><span class="o">?</span> <span class="o">and</span> <span class="nx">topic</span>  <span class="o">not</span> <span class="k">in</span> <span class="nx">_topics</span>
      <span class="nx">topics</span><span class="p">.</span><span class="nx">push</span> <span class="p">{</span><span class="nx">topic</span><span class="p">,</span><span class="nx">since</span><span class="o">:</span><span class="nx">time</span><span class="p">}</span>
      <span class="nx">_topics</span><span class="p">.</span><span class="nx">push</span> <span class="nx">topic</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>If we do not have an actual message, we can continue</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">continue</span> <span class="nx">unless</span> <span class="nx">message</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>else update the messages buffer</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">res = </span><span class="p">{</span><span class="nx">time</span><span class="p">,</span><span class="nx">user</span><span class="p">,</span><span class="nx">message</span><span class="p">,</span><span class="nx">topic</span><span class="o">:</span><span class="nx">topic</span> <span class="o">?</span> <span class="s">&quot;&quot;</span><span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>END Matching Loop</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>Finally return the messages:</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">return</span> <span class="nx">messages</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <h3>Date.fromClockTime</h3>

<p>Adds a helper for the Date Object to be able to parse clock times.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nb">Date</span><span class="p">.</span><span class="nv">fromClockTime = </span><span class="nf">(time) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>Start with the epoch and just pass in some 24h clock time</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">return</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nb">Date</span><span class="p">.</span><span class="nx">parse</span> <span class="s">&quot;Thu, 01 Jan 1970 </span><span class="si">#{</span><span class="nx">time</span><span class="si">}</span><span class="s"> GMT-0000&quot;</span><span class="p">)</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 