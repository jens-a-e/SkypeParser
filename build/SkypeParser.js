// Generated by CoffeeScript 1.3.2

/*
# Parse Messages from a Skype conversation in to a JSON Object.
# jens a. ewald, ififelse.net, 2012, licensed by the unlicence
*/


(function() {
  var __indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };

  String.prototype.parsefromSkype = function() {
    var command, include, index, match, message, messages, newuser, parser, platform_is_windows, res, time, token, topic, topics, user, users, _result, _topics, _users;
    platform_is_windows = this.match(/^\[\d{2}/);
    parser = platform_is_windows ? /(\[(\d{2}:\d{2}:\d{2})\])\s(((.+):\s([\s\S]+?))|((\*{3})\s(((.+)\shat\s(.+?)\shinzu.+)|((.+)\shat\sdas\s(Thema).+\sin\s"(.+)"))\s\*{3}))(?=(\r\n\[\d{2}:\d{2}:\d{2}\])|$)/g : /((((.*)\s((\d+)\.(\d+)\.(\d+)\s+(\d+):(\d+))(?=\s|\n))((.|(\n(?!.*\d{2}\.)))+)))/g;
    include = platform_is_windows ? [2, 5, 6, 8, 14, 15, 16, 11, 12] : [];
    _topics = [];
    topics = [];
    _users = [];
    users = [];
    messages = (function() {
      var _ref, _results;
      _results = [];
      while (_result = parser.exec(this)) {
        _ref = new Array(7), time = _ref[0], user = _ref[1], message = _ref[2], token = _ref[3], command = _ref[4], newuser = _ref[5];
        res = (function() {
          var _i, _len, _results1;
          _results1 = [];
          for (index = _i = 0, _len = _result.length; _i < _len; index = ++_i) {
            match = _result[index];
            if (__indexOf.call(include, index) >= 0 && match !== void 0) {
              _results1.push(match);
            }
          }
          return _results1;
        })();
        if (res.length === 3) {
          time = res[0], user = res[1], message = res[2];
        } else if (res.length === 4) {
          time = res[0], token = res[1], user = res[2], newuser = res[3];
        } else if (res.length === 5) {
          time = res[0], token = res[1], user = res[2], command = res[3], topic = res[4];
        }
        time = Date.fromClockTime(time);
        if (user && __indexOf.call(_users, user) < 0) {
          users.push({
            name: user,
            joined_on: time
          });
          _users.push(user);
        }
        if (newuser && __indexOf.call(_users, newuser) < 0) {
          users.push({
            name: newuser,
            joined_on: time
          });
          _users.push(newuser);
        }
        if (topic && __indexOf.call(_topics, topic) < 0) {
          topics.push({
            name: topic,
            since: time
          });
          _topics.push(topic);
        }
        if (!message) {
          continue;
        }
        _results.push(res = {
          time: time,
          user: user,
          message: message,
          topic: topic != null ? topic : ""
        });
      }
      return _results;
    }).call(this);
    return {
      users: users,
      topics: topics,
      messages: messages
    };
  };

  Date.fromClockTime = function(time) {
    return new Date(Date.parse("Thu, 01 Jan 1970 " + time + " GMT-0000"));
  };

}).call(this);
